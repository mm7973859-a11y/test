<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ØªØ¬Ø± Ø§Ù„Ø¨ØªÙˆÙ„</title>
<style>
body{margin:0;font-family:Arial;background:#0d1b2a;color:#fff}
header{background:#8b0000;padding:15px;text-align:center;font-size:22px}
.products{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;padding:10px}
.card{background:#1b263b;padding:10px;border-radius:10px;text-align:center;position:relative}
.card img{width:100%;height:120px;object-fit:cover;border-radius:8px}
button{background:#8b0000;color:#fff;border:none;padding:7px;margin:4px;border-radius:6px}
input,select{padding:8px;width:90%;margin:5px;border-radius:6px;border:none}
.order{background:#1b263b;margin:10px;padding:10px;border-radius:8px}
.hidden{display:none}
#loader{position:fixed;inset:0;background:#0008;display:flex;align-items:center;justify-content:center;font-size:22px}
.toast{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#8b0000;padding:10px;border-radius:8px;display:none}
</style>
</head>
<body>

<div id="loader">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
<header>ğŸ›’ Ù…ØªØ¬Ø± Ø§Ù„Ø¨ØªÙˆÙ„</header>
<div class="toast" id="toast">ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>

<input id="search" placeholder="Ø¨Ø­Ø«..." oninput="renderProducts()">

<div class="products" id="products"></div>

<h3>Ø§Ù„Ø³Ù„Ø©</h3>
<div id="cartList"></div>
<div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total">0</span> Ø¬</div>
<button onclick="checkout()" id="checkoutBtn">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</button>

<h3>Ø·Ù„Ø¨Ø§ØªÙŠ</h3>
<div id="myOrders"></div>

<h3 id="adminTitle" class="hidden">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</h3>
<div id="adminPanel" class="hidden"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig={apiKey:"YOUR_KEY",authDomain:"YOUR_DOMAIN",projectId:"YOUR_ID"};
const ADMIN_EMAIL="YOUR_ADMIN_EMAIL";

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

let productsArr=[];
let cart=JSON.parse(localStorage.getItem("cart")||"[]");

function normalize(t){return t.replace(/[Ø£Ø¥Ø¢]/g,"Ø§").toLowerCase();}

function showToast(msg){toast.innerText=msg;toast.style.display="block";setTimeout(()=>toast.style.display="none",1500);}

async function loadProducts(){
 const snap=await getDocs(collection(db,"products"));
 productsArr=[];snap.forEach(d=>productsArr.push({...d.data(),id:d.id}));
 renderProducts();loader.style.display="none";
}

window.renderProducts=()=>{
 const s=normalize(search.value||"");
 products.innerHTML="";
 productsArr.filter(p=>normalize(p.name).includes(s)&&p.stock>0)
 .forEach(p=>{
  products.innerHTML+=`
  <div class="card">
   <img src="${p.img}">
   <h4>${p.name}</h4>
   <p>${p.price} Ø¬</p>
   <p>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${p.stock}</p>
   <button onclick='addToCart("${p.id}")'>Ø£Ø¶Ù</button>
  </div>`;
 });
}

window.addToCart=(id)=>{
 const p=productsArr.find(x=>x.id===id);
 const f=cart.find(x=>x.id===id);
 f?f.qty++:cart.push({...p,qty:1});
 localStorage.setItem("cart",JSON.stringify(cart));
 updateCart();
 showToast("Ø£Ø¶ÙŠÙ Ù„Ù„Ø³Ù„Ø©");
}

function updateCart(){
 cartList.innerHTML="";
 let t=0;
 cart.forEach((i,index)=>{
  t+=i.price*i.qty;
  cartList.innerHTML+=`${i.name} Ã— ${i.qty}
  <button onclick="cart[${index}].qty++;updateCart()">+</button>
  <button onclick="cart.splice(${index},1);updateCart()">Ø­Ø°Ù</button><br>`;
 });
 total.innerText=t;
 localStorage.setItem("cart",JSON.stringify(cart));
}

window.checkout=async()=>{
 if(cart.length===0) return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©");
 checkoutBtn.disabled=true;

 for(const item of cart){
  const refDoc=doc(db,"products",item.id);
  const snap=await getDoc(refDoc);
  const currentStock=snap.data().stock;
  if(currentStock<item.qty){alert("Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± ÙƒØ§ÙÙ");checkoutBtn.disabled=false;return;}
  await updateDoc(refDoc,{stock:currentStock-item.qty});
 }

 await addDoc(collection(db,"orders"),{items:cart,total:total.innerText,status:"Ø¬Ø¯ÙŠØ¯",date:new Date()});
 cart=[];updateCart();showToast("ØªÙ… Ø§Ù„Ø·Ù„Ø¨");checkoutBtn.disabled=false;
}

loadProducts();
updateCart();
</script>

</body>
</html>